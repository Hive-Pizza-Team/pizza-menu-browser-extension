
HIVE_APPS = {

// blogging
    broadhive:     {id: 'broadhive', name: 'Broadhive', icon: '', url: 'https://www.broadhive.org', description: ''},
    cinetv:        {id: 'cinetv', name: 'CineTV', icon: '', url: 'https://www.cinetv.blog/trending', description: ''},
    dbuzz:         {id: 'dbuzz', name: 'dBuzz', icon: '', url: 'https://blog.d.buzz', description: ''},
    dunksocial:    {id: 'dunksocial', name: 'Dunk Social', icon: '', url: 'https://dunksocial.io', description: ''},
    ecency:        {id: 'ecency', name: 'Ecency', icon: '', url: 'https://ecency.com/', description: ''},
    'hive.blog':   {id: 'hive.blog', name: 'Hive.blog', icon: '', url: 'https://hive.blog/', description: ''},
    leofinance:    {id: 'leofinance', name: 'Leo Finance', icon: '', url: 'https://leofinance.io/', description: ''},
    oneup:         {id: 'oneup', name: 'OneUP', icon: '', url: 'https://www.1up.zone/', description: ''},
    palnet:        {id: 'palnet', name: 'PALNet', icon: '', url: 'https://www.palnet.io', description: ''},
    peakd:         {id: 'peakd', name: 'PeakD', icon: '', url: 'https://peakd.com/', description: 'The intuitive way to experience everything HIVE'},
    proofofbrain:  {id: 'proofofbrain', name: 'Proof of Brain', icon: '', url: 'https://www.proofofbrain.io', description: ''},
    splintertalk:  {id: 'splintertalk', name: 'Splintertalk', icon: '', url: 'https://www.splintertalk.io/', description: ''},
    stemgeeks:     {id: 'stemgeeks', name: 'Stem Geeks', icon: '', url: 'https://stemgeeks.net/', description: ''},
  
// gaming
    brewmaster:    {id: 'brewmaster', name: 'Crypto Brewmaster', icon: '', url: 'https://www.cryptobrewmaster.io/home', description: ''},
    dcity:         {id: 'dcity', name: 'dCity', icon: '', url: 'https://dcity.io', description: ''},
    dcrops:        {id: 'dcrops', name: 'dCrops', icon: '', url: 'https://dcrops.com', description: ''},
    exode:         {id: 'exode', name: 'EXODE', icon: '', url: 'https://exodegame.com/', description: ''},
    hashkings:     {id: 'hashkings', name: 'HashKings', icon: '', url: 'https://farm.hashkings.app/play', description: ''},
    rabona:        {id: 'rabona', name: 'Rabona', icon: '', url: 'http://rabona.io', description: ''},
    risingstar:    {id: 'risingstar', name: 'RisingStar', icon: '', url: 'https://www.risingstargame.com/', description: ''},
    splinterlands: {id: 'splinterlands', name: 'Splinterlands', icon: '', url: 'https://splinterlands.com/', description: ''},
    unsunghero:    {id: 'unsunghero', name: 'Unsung Hero', icon: '', url: 'http://unsunghero.fun/', description: ''},

// markets
    hivelist:      {id: 'hivelist', name: 'HiveList', icon: '', url: 'https://hivelist.io/', description: 'HiveCommerce marketplace community'},
    gamestore:     {id: 'gamestore', name: 'Video Game Store', icon: '', url: 'https://hive.pizza/shop/', description: 'PIZZA Steam Video Game Store'},
    'hive-engine': {id: 'hive-engine', name: 'Hive Engine', icon: '', url: 'https://hive-engine.com/', description: ''},
    leodex:        {id: 'leodex', name: 'Leo Dex', icon: '', url: 'https://leodex.io', description: ''},
    nftmart:       {id: 'nftmart', name: 'NFTMart', icon: '', url: 'https://nftm.art', description: ''},
    tribaldex:     {id: 'tribaldex', name: 'Tribaldex', icon: '', url: 'https://tribaldex.com', description: ''},

// music & art
    creativecoin:  {id: 'creativecoin', name: 'CreativeCoin', icon: '', url: 'https://www.creativecoin.xyz', description: ''},
    lensy:         {id: 'lensy', name: 'Lensy', icon: '', url: 'https://lensy.io/', description: ''},
    nftshowroom:   {id: 'nftshowroom', name: 'NFTShowroom', icon: '', url: 'https://nftshowroom.com/',  description: 'Collectible, scarce, tokenized art'},
    musicforlife:  {id: 'musicforlife', name: 'MusicForLife', icon: '', url: 'https://www.musicforlife.io', description: ''},

// PizzaTools
    pizzawebsite:       {id: 'pizzawebsite', name: 'hive.pizza', icon: '', url: 'https://www.hive.pizza', description: 'hive.pizza website'},
    discord:            {id: 'discord', name: 'PIZZA Discord', icon: '', url: 'https://www.discord.gg/hivepizza', description: 'hive.pizza Discord'},
    staketool:          {id: 'staketool', name: 'HE Staking Tool', icon: '', url: 'https://www.hive.pizza/showcase', description: 'Stake all HE tokens easily with one click'},
    hivebeautiful:      {id: 'hivebeautiful', name: 'Hive Is Beautiful', icon: '', url: 'https://hiveuprss.github.io/hiveisbeautiful/', description: 'Visualize block data in a beautiful way'},
    transferstream:     {id: 'transferstream', name: 'Hive Transfer Stream', icon: '', url: 'https://hiveuprss.github.io/transferstream/', description: 'Data stream of HIVE transfers in real-time'},
    hiverss:            {id: 'hiverss', name: 'HiveRSS', icon: '', url: 'https://hiverss.com/', description: 'A simple tool for creating Atom/RSS feeds from Hive accounts and categories.'},

// video & media
    vimmtv:        {id: 'vimmtv', name: 'VimmTV', icon: '', url: 'https://www.vimm.tv/', description: 'Streaming service for content creators'},
    aureal:        {id: 'aureal', name: 'Aureal', icon: '', url: 'https://aureal.one/', description: 'Monetize your podcasts easily'},
    threespeak:    {id: 'threespeak', name: '3Speak', icon: '', url: 'https://3speak.tv/', description: 'Tokenized video communities'},
    dtube:         {id: 'dtube', name: 'dTube', icon: '', url: 'https://d.tube/', description: 'Video hosting services'},

 // wallets
    keychain:      {id: 'keychain', name: 'Keychain', icon: '', url: 'https://chrome.google.com/webstore/detail/hive-keychain/jcacnejopjdphbnjgfaaobbfafkihpep?hl=en', description: 'HIVE browser extension wallet'},
    hivesigner:    {id: 'hivesigner', name: 'Hivesigner', icon: '', url: 'https://hivesigner.com/', description: 'Hive browser wallet'},
    vessel:        {id: 'vessel', name: 'Vessel', icon: '', url: 'https://gitlab.syncad.com/hive/vessel/-/releases', description: 'Hive desktop Wallet'},
    hivewallet:    {id: 'hivewallet', name: 'Hivewallet', icon: '', url: 'https://hivewallet.app/', description: 'Hive mobile wallet'},

  
// utilities  
    hiveblocks:    {id: 'hiveblocks', name: 'Hiveblocks', icon: '', url: 'https://hiveblocks.com/', description: 'Hive block explorer tool'},
    hivesearcher:  {id: 'hivesearcher', name: 'Hivesearcher', icon: '', url: 'https://hivesearcher.com/', description: 'Search engine for Hive content'},
    hivestats:     {id: 'hivestats', name: 'HiveStats', icon: '', url: 'https://hivestats.io', description: ''},
    hivetasks:     {id: 'hivetasks', name: 'HiveTasks', icon: '', url: 'https://hivetasks.com/', description: ''},
    hiveexplore:   {id: 'hiveexplore', name: 'HiveExplorer', icon: '', url: 'https://he.dtools.dev/', description: ''},

  
  
// null
//  null:          {id: '', name: '', icon: '', url: '', description: ''},

}

FAVORITE_APPS = []

RECENT_APPS = []


function expandAppData(apps) {
  return apps.map((id) => {return HIVE_APPS[id]})
}


function drawMenu() {

  // data
  var data = {categories: [ 
    {name: 'Favorites',     apps: getFavorites()},
    {name: 'Recents',       apps: getRecents()},
    {name: 'ArtAndMusic',   apps: expandAppData(['creativecoin', 'lensy', 'nftshowroom', 'musicforlife'])},
    {name: 'Blogging',      apps: expandAppData(['broadhive', 'cinetv', 'dbuzz', 'dunksocial', 'ecency', 'hive.blog', 'leofinance', 'oneup', 'palnet', 'peakd', 'proofofbrain','splintertalk', 'stemgeeks'])},
    {name: 'Gaming',        apps: expandAppData(['brewmaster', 'dcity', 'dcrops', 'exode', 'hashkings', 'rabona', 'risingstar', 'splinterlands', 'unsunghero'])},
    {name: 'Markets',       apps: expandAppData(['gamestore', 'hivelist', 'hive-engine','leodex', 'nftmart', 'tribaldex'])},
    {name: 'PizzaLabs',     apps: expandAppData(['pizzawebsite','discord','staketool', 'hivebeautiful', 'transferstream', 'hiverss'])},
    {name: 'VideoAndMedia', apps: expandAppData(['vimmtv', 'aureal','threespeak', 'dtube'])},
    {name: 'Wallets',       apps: expandAppData(['keychain', 'hivesigner','vessel', 'hivewallet'])},
    {name: 'Utilities',     apps: expandAppData(['hiveblocks', 'hivestats', 'hivesearcher', 'hivetasks', 'hiveexplore'])},
  ]};

  console.log(data)

  var source = document.querySelector('#menu-template').innerHTML;
  var template = Handlebars.compile(source);

  // data is passed to above template
  var output = template(data);
  document.querySelector('#menu').innerHTML = output;

  var source = document.querySelector('#submenu-template').innerHTML;
  var template = Handlebars.compile(source);

  // data is passed to above template
  var output = template(data);
  document.querySelector('#submenus').innerHTML = output;

  getFavorites().forEach( (app) => {
    Array.from(document.querySelectorAll(`a.nonfavorite#${app.id}`)).map((x) => {
      x.innerHTML = '<i class="fa fa-star" style="float:right" aria-hidden="true"></i>'
      x.className = 'favorite'
    })
  })


  function showSubmenu(event) {
    Array.from(document.querySelectorAll('.submenu')).forEach(element => {
        element.style.display = 'none'
      })

      let category = event.target.id.split('-')[1]
      
      let submenuCategory = document.querySelector(`#submenu-${category}`)
      if (submenuCategory) {
        submenuCategory.style.display = 'block'
      }
  }

  // set up event handlers
  data.categories.forEach(cat => {
    document.querySelector(`#cat-${cat.name}`).onclick = showSubmenu
    document.querySelector(`#cat-${cat.name}`).onmouseover = showSubmenu
  })

  Array.from(document.querySelectorAll('a.nonfavorite')).forEach(star => {
    star.onclick = (e) => {
      addFavorite(e.currentTarget.id)
      e.currentTarget.className = 'favorite'
    }
  })

  Array.from(document.querySelectorAll('a.favorite')).forEach(star => {
    star.onclick = (e) => {
      removeFavorite(e.currentTarget.id)
      e.currentTarget.className = 'nonfavorite'
    }
  })
}


function getFavorites() {
  var favorites = JSON.parse(window.localStorage.getItem('favorites'))
  if (favorites) {
    return favorites.map((id) => HIVE_APPS[id])
  }
  return []
}


function removeFavorite(id) {
  var favorites = JSON.parse(window.localStorage.getItem('favorites'))

  favorites = favorites.filter((x) => x != id)

  window.localStorage.setItem('favorites', JSON.stringify(favorites))

  drawMenu()
}


MAX_FAVORITES_COUNT = 7
MAX_RECENTS_COUNT = 7


function addFavorite(id) {
  var favorites = JSON.parse(window.localStorage.getItem('favorites'))
  if (favorites && favorites.length == MAX_FAVORITES_COUNT) {
    return
  }

  if (favorites && id) {
    favorites.push(id)
    window.localStorage.setItem('favorites', JSON.stringify(favorites))
  } else if (id) {
    window.localStorage.setItem('favorites', JSON.stringify([id]))
  }

  drawMenu()
}


function getRecents() {
  var recents = JSON.parse(window.localStorage.getItem('recents'))
  if (recents) {
    return recents.map((id) => HIVE_APPS[id])
  }
  return []
}


function updateRecents(id) {
  var recents = JSON.parse(window.localStorage.getItem('recents'))
  if (recents) {
    recents.unshift(id)
    recents.slice(0, MAX_RECENTS_COUNT) // only store MAX_RECENTS_COUNT most recent
    window.localStorage.setItem('recents', JSON.stringify(recents))
  } else {
    window.localStorage.setItem('recents', JSON.stringify([id]))
  }

  drawMenu()
}


function eraseAllData() {
  window.localStorage.removeItem('recents')
  window.localStorage.removeItem('favorites')

  // update visible menu
  drawMenu()
}


function handleClickButton(e) {
  if (typeof e.target.value !== 'undefined' && e.target.value != "") {
   chrome.runtime.sendMessage({
       url: e.target.value
     })
  }
}

function handleClickAnchor(e) {
  if (typeof e.target.href !== 'undefined' && e.target.href != "") {
    updateRecents(e.target.id)
    chrome.runtime.sendMessage({
        url: e.target.href
      })
  }
}

var buttons = document.querySelectorAll('button.dapplink')
buttons.forEach(function(button) {
 addEventListener('click', handleClickButton)
})

var anchors = document.querySelectorAll('a')
anchors.forEach(function(button) {
  addEventListener('click', handleClickAnchor)
})


document.querySelector('button#reset').onclick = eraseAllData

drawMenu()
